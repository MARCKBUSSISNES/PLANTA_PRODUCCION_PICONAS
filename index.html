<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PLANTA DE PRODUCCI√ìN ‚Ä¢ PICONAS ‚Äî Sistema Pro</title>

  <!-- Librer√≠as CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-SzlrxWriCjc5X5Q6pK0b1jvQ5c1q2pJZc+QJ5m6aYq0Y1e0bQ4j3I2z4Q5s6A8x7YkGf6y8Kf3Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- THEME & LAYOUT --- */
    :root{
      --bg:#0f1724; --panel:#0b1220; --muted:#9aa6b2; --accent:#06b6d4; --accent-2:#ff7a59; --glass:rgba(255,255,255,0.04);
      --radius:14px; --shadow: 0 10px 30px rgba(2,6,23,0.6);
      --glass-2: rgba(255,255,255,0.02);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:linear-gradient(180deg,#071021 0%, #071827 60%); color:#e6eef3}
    header{display:flex; align-items:center; gap:18px; padding:18px 28px}
    header h1{font-size:18px; margin:0}

    .app{display:grid; grid-template-columns:260px 1fr 360px; gap:18px; padding:20px}
    @media(max-width:1100px){ .app{grid-template-columns:1fr; grid-auto-rows:min-content;} .right{order:3} }

    .panel{background:linear-gradient(180deg,var(--panel), rgba(6,11,17,0.7)); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow);}

    /* SIDEBAR */
    .brand{display:flex; gap:12px; align-items:center}
    .brand .logo{width:44px; height:44px; background:linear-gradient(90deg,var(--accent), #0ea5ad); border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:700}
    .menu{margin-top:14px; display:flex; flex-direction:column; gap:6px}
    .menu button{background:transparent; color:var(--muted); border:none; text-align:left; padding:10px 12px; border-radius:10px; cursor:pointer}
    .menu button.active{background:linear-gradient(90deg, rgba(6,182,212,0.08), rgba(255,122,89,0.04)); color:var(--accent); font-weight:600}

    .quick-stats{display:grid; gap:8px; margin-top:12px}
    .stat{background:var(--glass); padding:10px; border-radius:10px}
    .stat h3{margin:0; font-size:14px}
    .stat p{margin:6px 0 0; font-size:20px; font-weight:700}

    /* MAIN */
    .header-actions{display:flex; gap:10px; align-items:center}
    .search{background:var(--glass-2); padding:8px 12px; border-radius:10px; display:flex; gap:8px; align-items:center}
    .search input{background:transparent; border:none; outline:none; color:inherit}
    .grid{display:grid; grid-template-columns:1fr 420px; gap:18px}
    @media(max-width:1100px){ .grid{grid-template-columns:1fr}}

    .card{padding:14px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));}
    .card h2{margin:0 0 8px 0}
    .flex{display:flex; gap:8px; align-items:center}
    .btn{background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; padding:8px 10px; border-radius:8px; cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent), #0ea5ad); color:#002026; border:none}
    .btn.warn{background:linear-gradient(90deg,var(--accent-2), #ff936e); color:#2b0d00; border:none}

    /* tables */
    table{width:100%; border-collapse:collapse}
    th, td{padding:8px; text-align:left; font-size:13px}
    tbody tr{border-bottom:1px solid rgba(255,255,255,0.03)}
    .small{font-size:13px; color:var(--muted)}

    /* forms */
    label{display:block; margin-bottom:6px; color:var(--muted); font-size:13px}
    input, textarea, select{width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:inherit}
    textarea{min-height:90px}

    /* RIGHT PANEL */
    .timeline{max-height:70vh; overflow:auto; display:flex; flex-direction:column; gap:10px}
    .event{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.08)); padding:10px; border-radius:8px}
    .badge{padding:6px 8px; border-radius:999px; font-size:12px}
    .badge.green{background:rgba(16,185,129,0.12); color:#10b981}
    .badge.orange{background:rgba(255,159,67,0.12); color:#ff7a59}

    footer{color:var(--muted); text-align:center; padding:14px}

    /* modal */
    .modal-backdrop{position:fixed; inset:0; display:none; background:linear-gradient(0deg, rgba(0,0,0,0.5), rgba(0,0,0,0.5)); align-items:center; justify-content:center}
    .modal{width:920px; max-width:95%; background:rgba(6,11,17,0.95); border-radius:12px; padding:18px}

    /* responsive tweaks */
    @media(max-width:700px){ .app{padding:12px} .right{display:none} .card h2{font-size:16px} }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">P</div>
      <div>
        <h1>PLANTA DE PRODUCCI√ìN ‚Ä¢ PICONAS</h1>
        <div class="small">Sistema Pro ‚Äî Local (GitHub Pages) ¬∑ Guardado en browser</div>
      </div>
    </div>
    <div style="flex:1"></div>
    <div class="header-actions">
      <div class="search"><i class="fa fa-search"></i><input id="globalSearch" placeholder="Buscar recetas, ingredientes, producci√≥n..." /></div>
      <button class="btn" id="btnImport">Importar JSON</button>
      <button class="btn" id="btnExport">Exportar JSON</button>
      <button class="btn primary" id="openLogin">Login</button>
    </div>
  </header>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="panel">
      <div class="brand">
        <div style="flex:1">
          <div style="font-weight:700">M√≥dulos</div>
          <div class="small">Roles: admin / operario ‚Ä¢ Admin: admin / 22782522</div>
        </div>
      </div>

      <div class="menu" id="menu">
        <button data-view="overview" class="active">üìä Overview</button>
        <button data-view="recetas">üç≤ Recetas</button>
        <button data-view="inventario">üì¶ Inventario</button>
        <button data-view="produccion">üè≠ Producci√≥n</button>
        <button data-view="lotes">üîñ Lotes</button>
        <button data-view="reportes">üìà Reportes</button>
        <button data-view="usuarios">üîê Usuarios</button>
      </div>

      <div class="quick-stats">
        <div class="stat"><h3>Recetas</h3><p id="s_recetas">0</p></div>
        <div class="stat"><h3>Ingredientes</h3><p id="s_insumos">0</p></div>
        <div class="stat"><h3>Producciones</h3><p id="s_producciones">0</p></div>
      </div>
    </aside>

    <!-- MAIN -->
    <main>
      <!-- OVERVIEW -->
      <section class="panel card view" id="view-overview">
        <div class="grid">
          <div>
            <h2>Resumen & Tareas</h2>
            <div class="card" style="margin-top:12px">
              <canvas id="chartProduccion" height="120"></canvas>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>√öltimas acciones</h3>
              <div id="feed" class="timeline"></div>
            </div>
          </div>

          <div>
            <h2>Alertas</h2>
            <div class="card" id="alerts" style="margin-top:12px"></div>
            <div style="height:12px"></div>
            <h2>Acciones r√°pidas</h2>
            <div class="card" style="margin-top:12px">
              <div class="flex" style="flex-direction:column">
                <button class="btn primary" id="quickNewReceta">Nueva Receta</button>
                <button class="btn" id="quickStockIn">Entrada de stock</button>
                <button class="btn warn" id="quickNewLote">Crear Lote</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RECETAS -->
      <section class="panel card view" id="view-recetas" style="display:none">
        <div style="display:flex; gap:14px}">
          <div style="flex:1">
            <h2>Recetas</h2>
            <div class="card" style="margin-top:12px">
              <label>Nombre</label>
              <input id="receta_nombre" placeholder="Ej: Salsa Roja" />
              <label>Ingredientes (uno por l√≠nea: nombre|cantidad|unidad)</label>
              <textarea id="receta_ingredientes" placeholder="Tomate|5|kg
Sal|0.2|kg"></textarea>
              <label>Proceso</label>
              <textarea id="receta_proceso" placeholder="Paso 1...
Paso 2..."></textarea>
              <div style="margin-top:10px; display:flex; gap:8px"><button class="btn primary" id="saveReceta">Guardar</button><button class="btn" id="clearReceta">Limpiar</button></div>
            </div>
          </div>

          <div style="width:420px">
            <h2>Listado</h2>
            <div class="card" id="recetasList" style="max-height:60vh; overflow:auto"></div>
          </div>
        </div>
      </section>

      <!-- INVENTARIO -->
      <section class="panel card view" id="view-inventario" style="display:none">
        <h2>Inventario</h2>
        <div style="display:flex; gap:12px">
          <div style="flex:1">
            <div class="card">
              <label>Ingrediente</label>
              <input id="inv_nombre" placeholder="Tomate" />
              <label>Cantidad</label>
              <input id="inv_cantidad" type="number" step="any" />
              <label>Unidad</label>
              <input id="inv_unidad" placeholder="kg, L, un" />
              <label>Umbral alerta</label>
              <input id="inv_umbral" type="number" value="5" />
              <div style="margin-top:10px; display:flex; gap:8px"><button class="btn primary" id="inv_add">Agregar / Actualizar</button><button class="btn" id="inv_clear">Limpiar</button></div>
            </div>
          </div>
          <div style="width:420px">
            <div class="card" id="inv_list" style="max-height:70vh; overflow:auto"></div>
          </div>
        </div>
      </section>

      <!-- PRODUCCI√ìN -->
      <section class="panel card view" id="view-produccion" style="display:none">
        <h2>Producci√≥n</h2>
        <div style="display:flex; gap:12px">
          <div style="flex:1">
            <div class="card">
              <label>Receta</label>
              <select id="prod_receta"></select>
              <label>Cantidad</label>
              <input id="prod_cantidad" type="number" step="any" value="1" />
              <label>Responsable</label>
              <input id="prod_resp" placeholder="Nombre" />
              <label>Estado</label>
              <select id="prod_estado"><option value="programado">Programado</option><option value="en_proceso">En Proceso</option><option value="completado">Completado</option></select>
              <div style="margin-top:10px; display:flex; gap:8px"><button class="btn primary" id="prod_add">Registrar</button><button class="btn" id="prod_clear">Limpiar</button></div>
            </div>
          </div>
          <div style="width:420px">
            <h3>Lotes / Producciones</h3>
            <div class="card" id="prod_list" style="max-height:70vh; overflow:auto"></div>
          </div>
        </div>
      </section>

      <!-- LOTES -->
      <section class="panel card view" id="view-lotes" style="display:none">
        <h2>Lotes</h2>
        <div class="card" id="lotes_list" style="max-height:70vh; overflow:auto"></div>
      </section>

      <!-- REPORTES -->
      <section class="panel card view" id="view-reportes" style="display:none">
        <h2>Reportes</h2>
        <div class="card">
          <label>Periodo</label>
          <input id="r_fecha_inicio" type="date" />
          <input id="r_fecha_fin" type="date" />
          <div style="margin-top:10px"><button class="btn primary" id="r_generar">Generar PDF/CSV</button></div>
        </div>
        <div style="margin-top:12px" id="r_output"></div>
      </section>

      <!-- USUARIOS -->
      <section class="panel card view" id="view-usuarios" style="display:none">
        <h2>Usuarios</h2>
        <div style="display:flex; gap:12px">
          <div style="flex:1">
            <div class="card">
              <label>Usuario</label>
              <input id="u_user" />
              <label>Clave</label>
              <input id="u_pass" />
              <label>Rol</label>
              <select id="u_role"><option value="operario">Operario</option><option value="admin">Admin</option></select>
              <div style="margin-top:10px; display:flex; gap:8px"><button class="btn primary" id="u_add">Agregar/Actualizar</button><button class="btn" id="u_clear">Limpiar</button></div>
            </div>
          </div>
          <div style="width:420px"><div class="card" id="u_list" style="max-height:70vh; overflow:auto"></div></div>
        </div>
      </section>

      <footer class="panel card">PICONAS ‚Äî Sistema Pro ‚Ä¢ LocalStorage ‚Ä¢ &copy; <span id="year"></span></footer>
    </main>

    <!-- RIGHT PANEL -->
    <aside class="panel card right">
      <h3>Actividad / Historial</h3>
      <div id="activity" class="timeline"></div>
      <div style="height:12px"></div>
      <h3>Detalles r√°pidos</h3>
      <div class="card">
        <div id="quickInfo">Seleccione un elemento para ver detalles.</div>
      </div>
    </aside>
  </div>

  <!-- MODAL LOGIN -->
  <div class="modal-backdrop" id="modalLogin">
    <div class="modal">
      <h2>Acceder al sistema</h2>
      <div style="display:flex; gap:10px; margin-top:10px">
        <input id="login_user" placeholder="Usuario" />
        <input id="login_pass" placeholder="Clave" />
        <button class="btn primary" id="login_btn">Entrar</button>
      </div>
      <div style="margin-top:10px; text-align:right"><button class="btn" id="closeLogin">Cerrar</button></div>
    </div>
  </div>

  <!-- INPUT FILE (IMPORT) -->
  <input type="file" id="fileImport" accept="application/json" style="display:none" />

  <script>
    // -------------------- UTIL DB --------------------
    const Keys = { REC:'pp_recetas_v2', INV:'pp_inventario_v2', PROD:'pp_producciones_v2', LOT:'pp_lotes_v2', USERS:'pp_usuarios_v2', LOGS:'pp_logs_v2' };
    const LS = {
      load(k){ try{ return JSON.parse(localStorage.getItem(k) || '[]'); }catch(e){return[]} },
      save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
    };
    function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
    function now(){ return new Date().toISOString(); }
    function addLog(type, msg){ const logs = LS.load(Keys.LOGS); logs.unshift({id:uid('log'),time:now(),type,msg}); LS.save(Keys.LOGS,logs); renderActivity(); }

    // -------------------- SEED ADMIN --------------------
    (function seed(){ const users = LS.load(Keys.USERS); if(!users.find(u=>u.user==='admin')){ users.push({id:uid('u'),user:'admin',pass:'22782522',role:'admin'}); LS.save(Keys.USERS,users); addLog('sistema','Usuario admin inicial creado (admin / 22782522)'); } })();

    // -------------------- NAV --------------------
    document.querySelectorAll('#menu button').forEach(btn=> btn.addEventListener('click', ()=>{ document.querySelectorAll('#menu button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); const view = 'view-'+btn.dataset.view; document.querySelectorAll('.view').forEach(v=> v.style.display = v.id===view? '':'none'); renderAll(); }));

    // -------------------- DASHBOARD CHART --------------------
    let chart=null;
    function renderChart(){ const ctx = document.getElementById('chartProduccion').getContext('2d'); const prod = LS.load(Keys.PROD); const months = {}; prod.forEach(p=>{ const m = new Date(p.time).toLocaleString('default', {month:'short', year:'numeric'}); months[m] = (months[m]||0) + Number(p.cantidad||0); }); const labels = Object.keys(months).slice(-6); const data = labels.map(l=> months[l]||0); if(chart) chart.destroy(); chart = new Chart(ctx, {type:'bar', data:{labels, datasets:[{label:'Cantidad producida', data, backgroundColor:'rgba(6,182,212,0.8)'}]}, options:{responsive:true, plugins:{legend:{display:false}}}}); }

    // -------------------- RENDERERS --------------------
    function renderSummary(){ const r = LS.load(Keys.REC); const i = LS.load(Keys.INV); const p = LS.load(Keys.PROD); document.getElementById('s_recetas').textContent = r.length; document.getElementById('s_insumos').textContent = i.length; document.getElementById('s_producciones').textContent = p.length; }

    function renderActivity(){ const logs = LS.load(Keys.LOGS); const feed = document.getElementById('feed'); const act = document.getElementById('activity'); feed.innerHTML=''; act.innerHTML=''; logs.slice(0,50).forEach(l=>{ const d = document.createElement('div'); d.className='event'; d.innerHTML = `<div style="display:flex; justify-content:space-between"><div><b>${l.type}</b></div><div class="small">${new Date(l.time).toLocaleString()}</div></div><div class="small">${l.msg}</div>`; feed.appendChild(d); act.appendChild(d.cloneNode(true)); }); }

    // -------------------- RECETAS --------------------
    document.getElementById('saveReceta').addEventListener('click', ()=>{
      const nombre = document.getElementById('receta_nombre').value.trim(); const ingrRaw = document.getElementById('receta_ingredientes').value.trim(); const proceso = document.getElementById('receta_proceso').value.trim(); if(!nombre || !ingrRaw){ alert('Nombre e ingredientes requeridos'); return; }
      const ingredientes = ingrRaw.split('
').map(l=>{ const p=l.split('|').map(x=>x.trim()); return {nombre:p[0]||'', cantidad:parseFloat(p[1]||0), unidad:p[2]||''}; }).filter(x=>x.nombre);
      const recetas = LS.load(Keys.REC); const existing = recetas.find(r=> r.nombre.toLowerCase()===nombre.toLowerCase()); if(existing){ existing.ingredientes = ingredientes; existing.proceso = proceso; existing.updated = now(); addLog('receta',`Receta actualizada: ${nombre}`); } else { recetas.push({id:uid('r'),nombre,ingredientes,proceso,created:now()}); addLog('receta',`Receta creada: ${nombre}`); }
      LS.save(Keys.REC,recetas); renderRecetas(); renderSelectReceta(); renderSummary(); alert('Receta guardada');
    });

    function renderRecetas(){ const list = LS.load(Keys.REC); const cont = document.getElementById('recetasList'); cont.innerHTML=''; if(list.length===0){ cont.innerHTML='<div class="small">Sin recetas</div>'; return; } list.forEach(r=>{ const div=document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center"><div><b>${r.nombre}</b><div class='small'>${r.ingredientes.length} insumos</div></div><div><button class='btn' data-id='${r.id}' data-act='edit'>Editar</button> <button class='btn warn' data-id='${r.id}' data-act='lote'>Crear lote</button></div></div>`; cont.appendChild(div); });
      // attach events
      cont.querySelectorAll('button[data-act="edit"]').forEach(b=> b.addEventListener('click', ()=>{ const id=b.dataset.id; const r = LS.load(Keys.REC).find(x=>x.id===id); document.getElementById('receta_nombre').value = r.nombre; document.getElementById('receta_ingredientes').value = r.ingredientes.map(i=>`${i.nombre}|${i.cantidad}|${i.unidad}`).join('
'); document.getElementById('receta_proceso').value = r.proceso || ''; window.scrollTo({top:0, behavior:'smooth'}); }));
      cont.querySelectorAll('button[data-act="lote"]').forEach(b=> b.addEventListener('click', ()=>{ const id=b.dataset.id; const r = LS.load(Keys.REC).find(x=>x.id===id); createLoteFromReceta(id, r.nombre); }));
    }

    // -------------------- INVENTARIO --------------------
    document.getElementById('inv_add').addEventListener('click', ()=>{
      const nombre = document.getElementById('inv_nombre').value.trim(); const cantidad = parseFloat(document.getElementById('inv_cantidad').value) || 0; const unidad = document.getElementById('inv_unidad').value.trim(); const umbral = parseFloat(document.getElementById('inv_umbral').value) || 5; if(!nombre){ alert('Nombre requerido'); return; }
      const inv = LS.load(Keys.INV); const exist = inv.find(i=> i.nombre.toLowerCase()===nombre.toLowerCase()); if(exist){ exist.cantidad = (parseFloat(exist.cantidad)||0)+cantidad; exist.unidad = unidad || exist.unidad; exist.umbral = umbral; addLog('inventario', `Stock actualizado: ${nombre} +${cantidad}`); } else { inv.push({id:uid('i'),nombre,cantidad,unidad,umbral}); addLog('inventario', `Ingrediente agregado: ${nombre} (${cantidad} ${unidad})`); }
      LS.save(Keys.INV,inv); renderInventario(); renderSummary(); alert('Inventario actualizado');
    });

    function renderInventario(){ const inv = LS.load(Keys.INV); const cont = document.getElementById('inv_list'); cont.innerHTML=''; if(inv.length===0){ cont.innerHTML='<div class="small">Inventario vac√≠o</div>'; return; } inv.forEach(i=>{ const d=document.createElement('div'); d.className='card'; d.style.marginBottom='8px'; d.innerHTML = `<div style='display:flex; justify-content:space-between'><div><b>${i.nombre}</b><div class='small'>${i.cantidad} ${i.unidad} ‚Ä¢ umbral: ${i.umbral}</div></div><div><button class='btn' data-id='${i.id}' data-act='edit'>Editar</button><button class='btn warn' style='margin-left:6px' data-id='${i.id}' data-act='sub'>Retirar</button></div></div>`; cont.appendChild(d); });
      cont.querySelectorAll('button[data-act="edit"]').forEach(b=> b.addEventListener('click', ()=>{ const id=b.dataset.id; const i = LS.load(Keys.INV).find(x=>x.id===id); document.getElementById('inv_nombre').value = i.nombre; document.getElementById('inv_cantidad').value = i.cantidad; document.getElementById('inv_unidad').value = i.unidad; document.getElementById('inv_umbral').value = i.umbral; }));
      cont.querySelectorAll('button[data-act="sub"]').forEach(b=> b.addEventListener('click', ()=>{ const id=b.dataset.id; const q = prompt('Cantidad a retirar:'); const qty = parseFloat(q)||0; if(qty<=0) return; const inv = LS.load(Keys.INV); const idx = inv.findIndex(x=>x.id===id); if(idx>=0){ inv[idx].cantidad = Math.max(0, (parseFloat(inv[idx].cantidad)||0)-qty); LS.save(Keys.INV,inv); addLog('inventario', `Retirado ${qty} de ${inv[idx].nombre}`); renderInventario(); renderSummary(); } }));
    }

    // -------------------- PRODUCCI√ìN / LOTES --------------------
    function renderSelectReceta(){ const sel = document.getElementById('prod_receta'); sel.innerHTML=''; LS.load(Keys.REC).forEach(r=>{ const opt=document.createElement('option'); opt.value=r.id; opt.textContent=r.nombre; sel.appendChild(opt); }); }

    document.getElementById('prod_add').addEventListener('click', ()=>{
      const recetaId = document.getElementById('prod_receta').value; const cantidad = parseFloat(document.getElementById('prod_cantidad').value) || 0; const responsable = document.getElementById('prod_resp').value.trim(); const estado = document.getElementById('prod_estado').value; if(!recetaId || cantidad<=0){ alert('Seleccione receta y cantidad v√°lida'); return; }
      const receta = LS.load(Keys.REC).find(r=>r.id===recetaId);
      // verificar stock
      const inv = LS.load(Keys.INV);
      const faltan = [];
      receta.ingredientes.forEach(ing=>{ const requiere = (parseFloat(ing.cantidad)||0)*cantidad; const item = inv.find(x=> x.nombre.toLowerCase()===ing.nombre.toLowerCase()); const disp = item? parseFloat(item.cantidad)||0 : 0; if(disp < requiere) faltan.push({nombre:ing.nombre, requiere, disp, unidad:ing.unidad}); });
      if(faltan.length>0){ if(!confirm('Stock insuficiente para algunos ingredientes. Registrar de todos modos?')) return; }
      // descontar stock
      receta.ingredientes.forEach(ing=>{ const requiere = (parseFloat(ing.cantidad)||0)*cantidad; const idx = inv.findIndex(x=> x.nombre.toLowerCase()===ing.nombre.toLowerCase()); if(idx>=0){ inv[idx].cantidad = Math.max(0, (parseFloat(inv[idx].cantidad)||0) - requiere); } }); LS.save(Keys.INV,inv);

      // crear lote/produccion
      const prod = LS.load(Keys.PROD); const lote = { id:uid('p'), recetaId, receta:receta.nombre, cantidad, responsable, estado, time:now() }; prod.push(lote); LS.save(Keys.PROD,prod);
      addLog('produccion', `Lote creado: ${receta.nombre} x${cantidad} ‚Äî ${estado}`);
      renderProducciones(); renderInventario(); renderSummary(); alert('Producci√≥n registrada.');
    });

    function renderProducciones(){ const list = LS.load(Keys.PROD); const cont = document.getElementById('prod_list'); cont.innerHTML=''; if(list.length===0){ cont.innerHTML='<div class="small">Sin producciones</div>'; return; } list.slice().reverse().forEach(p=>{ const d=document.createElement('div'); d.className='card'; d.style.marginBottom='8px'; d.innerHTML = `<div style='display:flex; justify-content:space-between'><div><b>${p.receta}</b><div class='small'>${p.cantidad} ‚Ä¢ ${p.estado} ‚Ä¢ ${new Date(p.time).toLocaleString()}</div></div><div><button class='btn' data-id='${p.id}' data-act='toggle'>Cambiar</button> <button class='btn warn' data-id='${p.id}' data-act='del'>Eliminar</button></div></div>`; cont.appendChild(d); });
      cont.querySelectorAll('button[data-act="toggle"]').forEach(b=> b.addEventListener('click', ()=>{ const id=b.dataset.id; const prod = LS.load(Keys.PROD); const idx = prod.findIndex(x=>x.id===id); if(idx<0) return; const next = prod[idx].estado==='programado'?'en_proceso': prod[idx].estado==='en_proceso'?'completado':'programado'; prod[idx].estado = next; LS.save(Keys.PROD,prod); addLog('produccion', `Estado lote ${prod[idx].receta} -> ${next}`); renderProducciones(); renderChart(); }));
      cont.querySelectorAll('button[data-act="del"]').forEach(b=> b.addEventListener('click', ()=>{ const id=b.dataset.id; if(!confirm('Eliminar lote?')) return; const prod = LS.load(Keys.PROD); const idx = prod.findIndex(x=>x.id===id); if(idx<0) return; const removed = prod.splice(idx,1); LS.save(Keys.PROD,prod); addLog('produccion', `Lote eliminado: ${removed[0].receta}`); renderProducciones(); renderChart(); renderSummary(); }));
    }

    function createLoteFromReceta(recetaId, nombre){ document.getElementById('prod_receta').value = recetaId; document.getElementById('prod_cantidad').value = 1; document.getElementById('prod_resp').value = ''; document.getElementById('prod_estado').value = 'programado'; document.querySelector('[data-view="produccion"]').click(); }

    // -------------------- LOTES (agrupado) --------------------
    function renderLotes(){ const prod = LS.load(Keys.PROD); const cont = document.getElementById('lotes_list'); cont.innerHTML=''; if(prod.length===0){ cont.innerHTML='<div class="small">No hay lotes</div>'; return; } const agrup = {};
      prod.forEach(p=>{ agrup[p.receta] = agrup[p.receta]||[]; agrup[p.receta].push(p); });
      Object.keys(agrup).forEach(k=>{ const d=document.createElement('div'); d.className='card'; d.style.marginBottom='8px'; d.innerHTML = `<div style='display:flex; justify-content:space-between'><div><b>${k}</b><div class='small'>${agrup[k].length} lotes</div></div></div>`; cont.appendChild(d); }); }

    // -------------------- USUARIOS --------------------
    document.getElementById('u_add').addEventListener('click', ()=>{ const user = document.getElementById('u_user').value.trim(); const pass = document.getElementById('u_pass').value.trim(); const role = document.getElementById('u_role').value; if(!user||!pass){ alert('Usuario y clave requeridos'); return; } const users = LS.load(Keys.USERS); const idx = users.findIndex(u=>u.user.toLowerCase()===user.toLowerCase()); if(idx>=0){ users[idx].pass = pass; users[idx].role = role; addLog('usuario', `Usuario actualizado: ${user}`); } else { users.push({id:uid('u'),user,pass,role}); addLog('usuario', `Usuario creado: ${user}`); } LS.save(Keys.USERS,users); renderUsuarios(); alert('Usuario guardado'); });
    function renderUsuarios(){ const cont = document.getElementById('u_list'); cont.innerHTML=''; const users = LS.load(Keys.USERS); users.forEach(u=>{ const d=document.createElement('div'); d.className='card'; d.style.marginBottom='8px'; d.innerHTML = `<div style='display:flex; justify-content:space-between'><div><b>${u.user}</b><div class='small'>${u.role}</div></div><div><button class='btn' data-id='${u.id}' data-act='del'>Eliminar</button></div></div>`; cont.appendChild(d); }); cont.querySelectorAll('button[data-act="del"]').forEach(b=> b.addEventListener('click', ()=>{ if(!confirm('Eliminar usuario?')) return; const id=b.dataset.id; const users = LS.load(Keys.USERS); const idx = users.findIndex(x=>x.id===id); if(idx>=0){ const rem = users.splice(idx,1); LS.save(Keys.USERS,users); addLog('usuario', `Usuario eliminado: ${rem[0].user}`); renderUsuarios(); } })); }

    // -------------------- ALERTAS --------------------
    function renderAlerts(){ const inv = LS.load(Keys.INV); const cont = document.getElementById('alerts'); cont.innerHTML=''; const low = inv.filter(i=> parseFloat(i.cantidad||0) <= parseFloat(i.umbral||5)); if(low.length===0){ cont.innerHTML='<div class="small">Todo en niveles aceptables.</div>'; return; } low.forEach(i=>{ const d=document.createElement('div'); d.className='event'; d.innerHTML = `<div style='display:flex; justify-content:space-between'><div><b>${i.nombre}</b></div><div><span class='badge orange'>Bajo</span></div></div><div class='small'>${i.cantidad} ${i.unidad} ‚Ä¢ umbral ${i.umbral}</div>`; cont.appendChild(d); }); }

    // -------------------- IMPORT / EXPORT --------------------
    document.getElementById('btnExport').addEventListener('click', ()=>{ const dump = {
      recetas: LS.load(Keys.REC), inventario: LS.load(Keys.INV), producciones: LS.load(Keys.PROD), lotes: LS.load(Keys.LOT), usuarios: LS.load(Keys.USERS), logs: LS.load(Keys.LOGS)
    }; const blob = new Blob([JSON.stringify(dump, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pp_piconas_backup_'+(new Date()).toISOString().slice(0,10)+'.json'; a.click(); addLog('sistema','Exportado respaldo JSON'); });
    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileImport').click());
    document.getElementById('fileImport').addEventListener('change', (e)=>{ const f = e.target.files[0]; if(!f) return; const rdr = new FileReader(); rdr.onload = ()=>{ try{ const data = JSON.parse(rdr.result); if(confirm('¬øDesea reemplazar datos locales con este backup?')){ if(data.recetas) LS.save(Keys.REC, data.recetas); if(data.inventario) LS.save(Keys.INV, data.inventario); if(data.producciones) LS.save(Keys.PROD, data.producciones); if(data.usuarios) LS.save(Keys.USERS, data.usuarios); if(data.logs) LS.save(Keys.LOGS, data.logs); addLog('sistema','Importado backup JSON'); renderAll(); alert('Importaci√≥n completa'); } }catch(err){ alert('Archivo inv√°lido'); } }; rdr.readAsText(f); });

    // -------------------- SEARCH --------------------
    document.getElementById('globalSearch').addEventListener('input', (e)=>{ const q = e.target.value.toLowerCase(); // highlight matches in recetas & inventario
      const matchesR = LS.load(Keys.REC).filter(r=> r.nombre.toLowerCase().includes(q) || r.ingredientes.some(i=> i.nombre.toLowerCase().includes(q))); const matchesI = LS.load(Keys.INV).filter(i=> i.nombre.toLowerCase().includes(q)); // show basic results in right quickInfo
      const quick = document.getElementById('quickInfo'); if(!q){ quick.innerHTML = 'Seleccione un elemento para ver detalles.'; return; } quick.innerHTML = `<b>Resultados: ${matchesR.length} recetas ‚Ä¢ ${matchesI.length} insumos</b><div class='small'>Escriba enter para refinar (no implementado)</div>`; });

    // -------------------- LOGIN / AUTH (simple) --------------------
    let currentUser = null;
    document.getElementById('openLogin').addEventListener('click', ()=>{ document.getElementById('modalLogin').style.display='flex'; });
    document.getElementById('closeLogin').addEventListener('click', ()=>{ document.getElementById('modalLogin').style.display='none'; });
    document.getElementById('login_btn').addEventListener('click', ()=>{ const u = document.getElementById('login_user').value.trim(); const p = document.getElementById('login_pass').value.trim(); const users = LS.load(Keys.USERS); const me = users.find(x=> x.user.toLowerCase()===u.toLowerCase() && x.pass===p); if(!me){ alert('Credenciales inv√°lidas'); return; } currentUser = me; addLog('auth', `Inicio sesi√≥n: ${me.user}`); document.getElementById('modalLogin').style.display='none'; alert('Bienvenido ' + me.user); });

    // -------------------- QUICK ACTIONS --------------------
    document.getElementById('quickNewReceta').addEventListener('click', ()=> { document.querySelector('[data-view="recetas"]').click(); window.scrollTo({top:120, behavior:'smooth'}); });
    document.getElementById('quickStockIn').addEventListener('click', ()=>{ document.querySelector('[data-view="inventario"]').click(); });
    document.getElementById('quickNewLote').addEventListener('click', ()=>{ document.querySelector('[data-view="produccion"]').click(); });

    // -------------------- RENDER GLOBAL --------------------
    function renderAll(){ renderRecetas(); renderInventario(); renderSelectReceta(); renderProducciones(); renderLotes(); renderUsuarios(); renderActivity(); renderSummary(); renderAlerts(); renderChart(); }
    document.getElementById('year').textContent = new Date().getFullYear(); renderAll();

    // Expose some functions for console quick use
    window.PP = { LS, Keys, renderAll, addLog };
  </script>
</body>
</html>
